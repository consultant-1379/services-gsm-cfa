##
## GSM Call Failure Analysis Sub Cause Code Detailed Analysis by Access Area
##
## Velocity Parameter: 
##
##
## Named PreparedStatement Parameter:
##
##	    :CAUSE_GROUP
##		:EXTENDED_CAUSE
##	   
##
#if($CATEGORY_ID != "")
#set($columnsToFilter=["HIER321_ID", "CAUSE_GROUP", "EXTENDED_CAUSE","CATEGORY_ID"])
#else
#set($columnsToFilter=["HIER321_ID", "CAUSE_GROUP", "EXTENDED_CAUSE"])
#end

#if($CATEGORY_ID == '0')
	#set($columnsToSelect=["EVENT_TIME, IMSI, RELEASE_TYPE, TAC, VAMOS_NEIGHBOR_INDICATOR, RSAI, CHANNEL_TYPE, URGENCY_CONDITION, CATEGORY_ID, HIER3_ID"])
#elseif($CATEGORY_ID == '1' ||  $CATEGORY_ID == "")
	#set($columnsToSelect=["EVENT_TIME, IMSI, RELEASE_TYPE, TAC, VAMOS_NEIGHBOR_INDICATOR, RSAI, CHANNEL_TYPE, URGENCY_CONDITION, CATEGORY_ID, HIER3_ID","AF_CAUSE", "AF_ID"])
#end

SELECT 

	#if($count > 0)
	  top $count
	#end
	
	#if($csv == true)
   	      DATEADD(minute,$tzOffset,rawview.EVENT_TIME)AS 'Event Time',
   	    #else
   	      rawview.EVENT_TIME AS 'Event Time',
   	    #end  
	DIM_E_GSM_CFA_EVENTTYPE.CATEGORY_ID_DESC AS 'Event Type',
	topology.VENDOR AS 'RAN Vendor',
	topology.HIERARCHY_3 AS 'Controller',
	topology.HIERARCHY_1 AS 'Access Area',
	rawview.IMSI AS IMSI,
	rawview.TAC AS TAC,
	DIM_E_SGEH_TAC.MANUFACTURER AS 'Terminal Make',
	DIM_E_SGEH_TAC.MARKETING_NAME AS 'Terminal Model',
	DIM_E_GSM_CFA_RELEASE_TYPE.RELEASE_TYPE_DESC AS 'Release Type',
	DIM_E_GSM_CFA_URGENCY_CONDITION.URGENCY_CONDITION_DESC AS 'Urgency Condition',
	'$CAUSE_VALUE' AS 'Cause Group',
	'$EXTENDED_CAUSE_VALUE' AS 'Extended Cause Value',
	rawview.HIER3_ID AS 'HIER3_ID',
	:HIER321_ID as 'HIER321_ID',
	#if($CATEGORY_ID == '1' ||  $CATEGORY_ID == "")
     (case DIM_E_GSM_CFA_AF_CAUSE.ORIGIN when '' THEN '-' else (DIM_E_GSM_CFA_AF_CAUSE.SHORT_DESC) + ', ' + (DIM_E_GSM_CFA_AF_CAUSE.ORIGIN) end) as 'Assignment Failure Cause Description',
	#end

	DIM_E_GSM_CFA_CHANNEL_TYPE.CHANNEL_TYPE_DESC AS 'Channel Type',
	DIM_E_GSM_CFA_VAMOS_NEIGHBOR_INDICATOR.VAMOS_PAIR_ALLOCATION_BY_MS AS 'VAMOS Pair Allocation by MS',
	DIM_E_GSM_CFA_RSAI.RSAI_DESC AS 'RSAI'
		
FROM 
	#REPLACE_RAW_VIEW_WITH_RAW_TABLES_AND_FILTER_COLUMNS_WITH_TAC_EXCLUSION_SPECIFY_COLUMNS($TECH_PACK_LIST.getAllRawTables() "rawview" $columnsToFilter $columnsToSelect)  
	,DIM_E_SGEH_TAC,
	DIM_E_GSM_CFA_EVENTTYPE,
	DIM_E_GSM_CFA_URGENCY_CONDITION, 
	DIM_E_GSM_CFA_RELEASE_TYPE,
	DIM_E_GSM_CFA_VAMOS_NEIGHBOR_INDICATOR,
	DIM_E_GSM_CFA_RSAI,
	#if($CATEGORY_ID == '1' ||  $CATEGORY_ID == "")
        DIM_E_GSM_CFA_AF_CAUSE,
    #end
	DIM_E_GSM_CFA_CHANNEL_TYPE,
	(
		(
			select distinct
				HIERARCHY_3,
				HIERARCHY_1,
				VENDOR
			from 
				DIM_E_SGEH_HIER321 
			where 
				RAT = 0
				and HIER321_ID = :HIER321_ID
		) as topology(HIERARCHY_3,HIERARCHY_1,VENDOR)
	)
WHERE 
	rawview.CATEGORY_ID = DIM_E_GSM_CFA_EVENTTYPE.CATEGORY_ID AND
	rawview.TAC *= DIM_E_SGEH_TAC.TAC AND
	rawview.RELEASE_TYPE = DIM_E_GSM_CFA_RELEASE_TYPE.RELEASE_TYPE AND
	rawview.VAMOS_NEIGHBOR_INDICATOR = DIM_E_GSM_CFA_VAMOS_NEIGHBOR_INDICATOR.VAMOS_NEIGHBOR_INDICATOR AND
	rawview.RSAI = DIM_E_GSM_CFA_RSAI.RSAI AND
	rawview.CHANNEL_TYPE = DIM_E_GSM_CFA_CHANNEL_TYPE.CHANNEL_TYPE AND
	#if($CATEGORY_ID == '1' ||  $CATEGORY_ID == "")
        rawview.AF_CAUSE = DIM_E_GSM_CFA_AF_CAUSE.AF_CAUSE AND
        rawview.AF_ID = DIM_E_GSM_CFA_AF_CAUSE.AF_ID AND
	#end
	rawview.URGENCY_CONDITION = DIM_E_GSM_CFA_URGENCY_CONDITION.URGENCY_CONDITION 
ORDER BY
	rawview.EVENT_TIME desc